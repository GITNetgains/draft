<!-- Draft Order Button -->
<script id="draftorder-data" type="application/json">{
  "customer": {
    "id": {{ customer.id | json }},
    "email": {{ customer.email | json }},
    "first_name": {{ customer.first_name | json }},
    "last_name": {{ customer.last_name | json }}
  }
}
</script>

<!-- Fullscreen Modal Backdrop + Form -->
<div id="modal-overlay" style="display: none; position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 99999; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); justify-content: center; align-items: center;">
  <div style="background: #fff; padding: 24px; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 0 0 1px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.2); position: relative; overflow-y: auto; max-height: 90vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
    <button id="close-modal" style="position: absolute;top: 12px;right: 12px;background: none;border: none;font-size: 24px;cursor: pointer;">&times;</button>
    <h2 style="margin-bottom: 20px; font-size: 20px;">Shipping address</h2>

    <div style="display: flex; flex-wrap: wrap; gap: 16px;">
      <div style="flex: 1 1 100%;">
        <label>Country</label>
        <select id="country" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;">
          <option value="">Select country</option>
        </select>
        <div class="error-message" id="error-country"></div>
      </div>
      <div style="flex: 1 1 100%;">
        <label>Company</label>
        <input id="company" type="text" placeholder="Optional" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
      </div>
      <div style="flex: 1 1 100%;">
        <label>Address</label>
        <input id="addr1" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
        <div class="error-message" id="error-addr1"></div>
      </div>
      <div style="flex: 1 1 100%;">
        <label>Apartment / Suite</label>
        <input id="apartment" type="text" placeholder="Optional" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
      </div>
      <div style="flex: 1 1 48%;">
        <label>City</label>
        <input id="city" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
        <div class="error-message" id="error-city"></div>
      </div>
      <div style="flex: 1 1 48%;">
        <label>State</label>
        <select id="state" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;">
          <option value="">Select state</option>
        </select>
        <div class="error-message" id="error-state"></div>
      </div>
      <div style="flex: 1 1 100%;">
        <label>PIN code</label>
        <input id="pin" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
        <div class="error-message" id="error-pin"></div>
      </div>
    </div>

    <label style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
      <input type="checkbox" id="same-as-shipping" checked />
      Billing address is same as shipping address
    </label>

    <div id="billing-address-form" style="display: none; margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
      <h3 style="margin-bottom: 10px;">Billing Address</h3>
      <div style="display: flex; flex-wrap: wrap; gap: 16px;">
        <div style="flex: 1 1 100%;">
          <label>Country</label>
          <select id="billing-country" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;">
            <option value="">Select country</option>
          </select>
          <div class="error-message" id="error-billing-country"></div>
        </div>
        <div style="flex: 1 1 48%;">
          <label>City</label>
          <input id="billing-city" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
          <div class="error-message" id="error-billing-city"></div>
        </div>
        <div style="flex: 1 1 48%;">
          <label>State</label>
          <select id="billing-state" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;">
            <option value="">Select state</option>
          </select>
          <div class="error-message" id="error-billing-state"></div>
        </div>
        <div style="flex: 1 1 100%;">
          <label>Company</label>
          <input id="billing-company" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
        </div>
        <div style="flex: 1 1 100%;">
          <label>Address</label>
          <input id="billing-addr1" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
          <div class="error-message" id="error-billing-addr1"></div>
        </div>
        <div style="flex: 1 1 100%;">
          <label>Apartment / Suite</label>
          <input id="billing-apartment" type="text" placeholder="Optional" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
        </div>
        <div style="flex: 1 1 100%;">
          <label>PIN code</label>
          <input id="billing-pin" type="text" style="width: 100%; padding: 10px 12px; border: 1px solid #c9cccf; border-radius: 6px;" />
          <div class="error-message" id="error-billing-pin"></div>
        </div>
      </div>
    </div>

    <button id="submit-address" style="background-color: {{ block.settings.background_color | default: '#070707ff' }}; color: {{ block.settings.text_color | default: '#ffffff' }}; padding: 12px; width: 100%; border: none; border-radius: 6px; font-size: 16px; margin-top: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;">
      <span id="submit-text">Submit</span>
      <svg id="submit-loader" xmlns="http://www.w3.org/2000/svg" style="display:none;" width="20" height="20" viewBox="0 0 50 50">
        <circle cx="25" cy="25" r="20" stroke="#fff" stroke-width="5" fill="none" stroke-linecap="round" />
      </svg>
    </button>
  </div>
</div>

<!-- SUCCESS MODAL -->
<div id="x-success-modal" style="display:none;position:fixed;inset:0;z-index:999999; background:rgba(0,0,0,0.45);backdrop-filter:blur(4px); justify-content:center;align-items:center;">
  <div style="background:white;width:90%;max-width:430px; padding:32px;border-radius:10px;text-align:center; box-shadow:0 8px 30px rgba(0,0,0,0.18);">
    <div id="x-success-tick" style="width:70px;height:70px;border-radius:50%; background:#39c36e;border:4px solid #39c36e; display:flex;justify-content:center;align-items:center; margin:0 auto 22px;font-size:38px;color:#FFFFFF; opacity:0;transform:scale(0.5); transition:all .35s ease;">✔</div>
    <h2 style="margin-bottom:10px;font-size:22px;font-weight:600;">Your order has been received.</h2>
    <p style="color:#666;margin-bottom:32px;font-size:15px;line-height:1.45;">Your draft order has been generated successfully. Thank you for choosing the Partial Payment option (40% now / 60% later). We will send the invoice for the initial 40% payment shortly, and the remaining 60% will be invoiced at the time of shipping. Please stay active on your email to receive regular updates about your order.</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="x-success-close" style="background:#1463ff;color:white;padding:12px 18px; border-radius:8px;font-size:16px;text-decoration:none; flex:1;text-align:center; border:none;outline:none;">Close</button>
    </div>
  </div>
</div>

<!-- ERROR MODAL -->
<div id="x-error-modal" style="display:none;position:fixed;inset:0;z-index:999999; background:rgba(0,0,0,0.45);backdrop-filter:blur(4px); justify-content:center;align-items:center;">
  <div style="background:white;width:90%;max-width:430px; padding:32px;border-radius:10px;text-align:center; box-shadow:0 8px 30px rgba(0,0,0,0.18);">
    <div id="x-error-cross" style="width:70px;height:70px;border-radius:50%; background:#d32f2f;border:4px solid #d32f2f; display:flex;justify-content:center;align-items:center; margin:0 auto 22px;font-size:38px;color:#FFFFFF; font-weight:700; opacity:0;transform:scale(0.5); transition:all .35s ease;">✖</div>
    <h2 style="margin-bottom:10px;font-size:22px;font-weight:600;color:#666">We couldn't complete your order at the moment</h2>
    <p style="color:#666;margin-bottom:32px;font-size:15px;line-height:1.45;">Please refresh the page and try again. If the issue continues, please contact support with your email and order details.</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button onclick="window.location.reload()" style="background:#1463ff;color:white;padding:12px 18px; border:none;border-radius:8px;font-size:16px; cursor:pointer;flex:1;">Refresh Page</button>
      <a href="mailto:hr@zioncases.com" style="flex:1;text-decoration:none;">
        <button style="background:white;color:#444; border:1px solid #ccc;padding:12px 18px; border-radius:8px;font-size:16px;cursor:pointer; width:100%;">Contact Support</button>
      </a>
    </div>
  </div>
</div>

<style>
  .error-message { color: #d32f2f; font-size: 13px; margin-top: 4px; }
  #create-draft-order-notification {
    background-color: {{ block.settings.background_color | default: '#070707ff' }};
    color: {{ block.settings.text_color | default: '#ffffff' }};
    padding: 12px; border: none; font-size: 16px; cursor: pointer; width: 100%; margin-top: 15px;
  }
  .create-draft-order-btn {
    display: block; width: 100%; text-align: center; padding: 14px;
    font-size: 14px; font-weight: 200; border: none; cursor: pointer; transition: all 0.2s ease;
  }
  .create-draft-order-btn.drawer-style {
    background: #1d1d1dff !important; color: #fff !important; border-radius: 14px !important;
    margin: 10px 0 !important; padding: 15px !important; font-weight: 100 !important;
  }
  .create-draft-order-btn.drawer-style:hover { background: #333 !important; }
  .create-draft-order-btn.notification-style { background: #4f5051; color: #fff; margin-bottom: 15px; }
  .create-draft-order-btn.notification-style:hover { transform: translateY(-3px); background: #6b6b6b; }
  @media (max-width: 750px) { #main { justify-content: center !important; } }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
(function() {
  // ===== PREVENT MULTIPLE INITIALIZATIONS =====
  if (window.draftOrderInitialized) return;
  window.draftOrderInitialized = true;

  const draftorderData = JSON.parse(document.getElementById('draftorder-data').textContent);

  // Toast container
  let toastContainer = document.createElement('div');
  toastContainer.id = 'toast-container';
  toastContainer.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000000;display:flex;flex-direction:column;gap:10px;max-width:300px;width:100%;pointer-events:none;align-items:center;';
  document.body.appendChild(toastContainer);

  function showToast(message, duration = 7000) {
    const toast = document.createElement('div');
    toast.style.cssText = 'background:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:6px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease;pointer-events:auto;';
    toast.textContent = message;
    toastContainer.appendChild(toast);
    requestAnimationFrame(() => { toast.style.opacity = '1'; });
    setTimeout(() => { toast.style.opacity = '0'; toast.addEventListener('transitionend', () => toast.remove()); }, duration);
  }

  // ===== OPTIMIZED COUNTRIES LOADING (ONCE) =====
  let countriesData = null;
  let countriesLoadPromise = null;

  async function loadCountriesOnce() {
    if (countriesData) return countriesData;
    if (countriesLoadPromise) return countriesLoadPromise;

    countriesLoadPromise = (async () => {
      try {
        const res = await fetch('{{ "countries_full.json" | asset_url }}');
        countriesData = await res.json();
        return countriesData.data || countriesData;
      } catch (e) {
        console.error("Error loading countries_full.json", e);
        return [];
      }
    })();

    return countriesLoadPromise;
  }

  async function setupCountryDropdown(selectId, stateId) {
    const countrySelect = document.getElementById(selectId);
    const stateSelect = document.getElementById(stateId);
    
    // Skip if already populated
    if (countrySelect.options.length > 1) return;

    const countries = await loadCountriesOnce();

    countries.forEach(c => {
      countrySelect.add(new Option(c.name, c.name));
    });

    countrySelect.addEventListener('change', () => {
      const selected = countries.find(c => c.name === countrySelect.value);
      stateSelect.innerHTML = '<option value="">Select state</option>';
      if (selected?.states?.length) {
        selected.states.forEach(state => {
          stateSelect.add(new Option(state, state));
        });
      }
    });
  }

  // ===== OPTIMIZED CART FETCHING =====
  let cachedCart = null;
  let lastCartFetch = 0;
  const CART_FETCH_COOLDOWN = 3000; // 3 seconds
  let cartFetchPromise = null;

  async function fetchCart(forceRefresh = false) {
    const now = Date.now();
    
    if (!forceRefresh && cachedCart && (now - lastCartFetch) < CART_FETCH_COOLDOWN) {
      return cachedCart;
    }
    
    if (cartFetchPromise) return cartFetchPromise;
    
    cartFetchPromise = (async () => {
      try {
        const res = await fetch('/cart.js');
        if (!res.ok) {
          console.warn('Cart fetch failed:', res.status);
          return cachedCart || { items: [] };
        }
        
        const text = await res.text();
        if (text.trim().startsWith('<')) {
          console.warn('Rate limit hit');
          return cachedCart || { items: [] };
        }
        
        const cart = JSON.parse(text);
        cachedCart = cart;
        lastCartFetch = Date.now();
        return cart;
      } catch (err) {
        console.error('Cart fetch error', err);
        return cachedCart || { items: [] };
      } finally {
        cartFetchPromise = null;
      }
    })();
    
    return cartFetchPromise;
  }

  function clearErrors(fields) {
    fields.forEach(field => {
      const errorEl = document.getElementById('error-' + field.id);
      if (errorEl) errorEl.textContent = '';
    });
  }

  function initializeDraftOrder() {
    const modal = document.getElementById('modal-overlay');
    const closeBtn = document.getElementById('close-modal');
    const submitBtn = document.getElementById('submit-address');
    const submitText = document.getElementById('submit-text');
    const submitLoader = document.getElementById('submit-loader');

    async function handleDraftOrderClick(e) {
      e.preventDefault();
      if (!draftorderData.customer?.email) {
        showToast("Please log in as a customer.");
        return;
      }
      
      const cart = await fetchCart(true); // Force refresh on open
      if (!cart.items || cart.items.length === 0) {
        showToast("Your cart is empty. Please add items first.");
        return;
      }
      
      // Load countries only when modal opens
      await setupCountryDropdown('country', 'state');
      await setupCountryDropdown('billing-country', 'billing-state');
      
      modal.style.display = 'flex';
    }

    // Main cart button
    const openBtn = document.getElementById('create-draft-order');
    if (openBtn) openBtn.addEventListener('click', handleDraftOrderClick);

    // ===== OPTIMIZED CART NOTIFICATION BUTTON =====
    let setupInProgress = false;
    const processedContainers = new WeakSet();

    async function setupCartNotificationButton() {
      if (setupInProgress) return;
      setupInProgress = true;

      try {
        const cart = await fetchCart();
        const containers = document.querySelectorAll('.cart-notification, #cart-notification, .cart-drawer, #CartDrawer');
        
        containers.forEach(container => {
          // Skip if already processed
          if (processedContainers.has(container)) return;
          
          const existingBtn = container.querySelector('#create-draft-order-notification');
          
          if (!cart.items || cart.items.length === 0) {
            if (existingBtn) existingBtn.remove();
            return;
          }
          
          if (existingBtn) return;
          
          const button = document.createElement('button');
          button.id = 'create-draft-order-notification';
          button.textContent = '{{ block.settings.text | default: "Partial Payment(40/60)" | escape }}';
          
          if (container.classList.contains('cart-drawer') || container.id === 'CartDrawer') {
            button.className = 'create-draft-order-btn drawer-style';
          } else {
            button.className = 'create-draft-order-btn notification-style';
          }
          
          const checkoutBtn = container.querySelector('[href="/checkout"], button[name="checkout"]');
          const linksSection = container.querySelector('.cart-notification__links, .cart-drawer__footer');
          
          if (checkoutBtn) {
            checkoutBtn.parentNode.insertBefore(button, checkoutBtn);
          } else if (linksSection) {
            linksSection.prepend(button);
          } else {
            container.appendChild(button);
          }
          
          button.addEventListener('click', handleDraftOrderClick);
          processedContainers.add(container);
        });
      } finally {
        setupInProgress = false;
      }
    }

    // Initialize on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    function init() {
      modal.style.display = 'none';
      document.body.appendChild(modal);
      
      const billingToggle = document.getElementById('same-as-shipping');
      const billingForm = document.getElementById('billing-address-form');
      if (billingToggle && billingForm) {
        billingToggle.addEventListener('change', () => {
          billingForm.style.display = billingToggle.checked ? 'none' : 'block';
        });
      }
      
      setupCartNotificationButton();
    }

    // ===== DEBOUNCED EVENT LISTENERS =====
    let updateTimeout;
    function debouncedSetup() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(setupCartNotificationButton, 500);
    }

    document.addEventListener('cart:updated', debouncedSetup);
    document.addEventListener('cart:drawer:open', setupCartNotificationButton);

    // ===== OPTIMIZED MUTATION OBSERVER =====
    let mutationTimeout;
    const observer = new MutationObserver(() => {
      clearTimeout(mutationTimeout);
      mutationTimeout = setTimeout(setupCartNotificationButton, 2000);
    });
    
    // Only observe specific cart areas
    const observeTargets = ['.cart-notification', '#cart-notification', '.cart-drawer', '#CartDrawer'];
    observeTargets.forEach(selector => {
      const target = document.querySelector(selector);
      if (target) {
        observer.observe(target, { childList: true, subtree: true });
      }
    });

    // Close modal
    if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });

    // Submit handler
    if (submitBtn) {
      submitBtn.addEventListener('click', async () => {
        const requiredFields = [
          { id: 'country', name: 'Country' },
          { id: 'addr1', name: 'Address' },
          { id: 'city', name: 'City' },
          { id: 'state', name: 'State' },
          { id: 'pin', name: 'PIN code' }
        ];

        const useShipping = document.getElementById('same-as-shipping').checked;
        if (!useShipping) {
          requiredFields.push(
            { id: 'billing-country', name: 'Billing Country' },
            { id: 'billing-addr1', name: 'Billing Address' },
            { id: 'billing-city', name: 'Billing City' },
            { id: 'billing-state', name: 'Billing State' },
            { id: 'billing-pin', name: 'Billing PIN code' }
          );
        }

        clearErrors(requiredFields);

        for (const field of requiredFields) {
          const el = document.getElementById(field.id);
          const errorEl = document.getElementById('error-' + field.id);
          if (!el || !el.value.trim()) {
            if (errorEl) errorEl.textContent = `${field.name} is required`;
            el?.focus();
            return;
          }
        }

        submitBtn.disabled = true;
        submitText.style.display = 'none';
        submitLoader.style.display = 'inline-block';
        submitLoader.style.animation = 'spin 1s linear infinite';

        const address = {
          address1: document.getElementById('addr1').value,
          apartment: document.getElementById('apartment').value,
          city: document.getElementById('city').value,
          state: document.getElementById('state').value,
          pin: document.getElementById('pin').value,
          company: document.getElementById('company').value,
          country: document.getElementById('country').value
        };

        const billingAddress = useShipping ? { ...address } : {
          address1: document.getElementById('billing-addr1').value,
          apartment: document.getElementById('billing-apartment').value,
          city: document.getElementById('billing-city').value,
          state: document.getElementById('billing-state').value,
          pin: document.getElementById('billing-pin').value,
          country: document.getElementById('billing-country').value,
          company: document.getElementById('billing-company').value
        };

        const cart = await fetchCart();
        const customer = draftorderData.customer;
        const discount = cart.discount_codes?.[0] || null;

        try {
          const response = await fetch('https://draft-lyart.vercel.app/api/create-draft-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer, cart, address, discount, billingAddress, useShipping })
          });

          const result = await response.json();

          if (result.success) {
            await fetch('/cart/clear.js', { method: 'POST' });
            modal.style.display = "none";

            const successModal = document.getElementById("x-success-modal");
            const tick = document.getElementById("x-success-tick");

            successModal.style.display = "flex";
            setTimeout(() => {
              tick.style.opacity = "1";
              tick.style.transform = "scale(1)";
            }, 100);

            setTimeout(() => {
              successModal.style.display = "none";
              window.location.reload();
            }, 10000);
          } else {
            modal.style.display = "none";

            const errorModal = document.getElementById("x-error-modal");
            const cross = document.getElementById("x-error-cross");

            errorModal.style.display = "flex";

            setTimeout(() => {
              cross.style.opacity = "1";
              cross.style.transform = "scale(1)";
            }, 80);
          }
        } catch (e) {
          showToast("An error occurred while creating draft order.");
          console.error(e);
        } finally {
          submitBtn.disabled = false;
          submitText.style.display = 'inline';
          submitLoader.style.display = 'none';
          submitLoader.style.animation = '';
        }
      });
    }
  }

  initializeDraftOrder();
  
  document.getElementById("x-success-close").onclick = () => {
    document.getElementById("x-success-modal").style.display = "none";
    window.location.reload();
  };
})();
</script>

{% schema %}
{
  "name": "Draft Order Button",
  "target": "body",
  "settings": [
    { "type": "text", "id": "text", "label": "Button Text", "default": "Create Draft Order" },
    { "type": "color", "id": "background_color", "label": "Button Background Color", "default": "#070707ff" },
    { "type": "color", "id": "text_color", "label": "Button Text Color", "default": "#ffffff" },
    {
      "type": "select", "id": "alignment", "label": "Button Alignment", "default": "flex-end",
      "options": [
        { "value": "flex-start", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "flex-end", "label": "Right" }
      ]
    }
  ],
  "enabled_on": { "templates": ["cart", "product", "collection", "index"] }
}
{% endschema %}