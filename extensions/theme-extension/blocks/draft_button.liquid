<!-- Draft Order Button -->
<script id="draftorder-data" type="application/json">{
  "customer": {
    "id": {{ customer.id | json }},
    "email": {{ customer.email | json }},
    "first_name": {{ customer.first_name | json }},
    "last_name": {{ customer.last_name | json }},
    "default_address": {{ customer.default_address | json }}
  }
}
</script>

<!-- Confirmation Modal -->
<div id="modal-overlay" style="display:none;position:fixed;inset:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);justify-content:center;align-items:center;">
  <div style="background:#fff;padding:32px;border-radius:12px;width:100%;max-width:500px;box-shadow:0 0 0 1px rgba(0,0,0,0.04), 0 1px 3px rgba(0,0,0,0.2);position:relative;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;">
    
    <button id="close-modal" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;">×</button>
    
    <div style="text-align:center;margin-bottom:32px;">
      <div style="width:56px;height:56px;background:rgba(239, 58, 36, 0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef3a24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h2 style="margin:0 0 12px 0;font-size:22px;font-weight:600;color:#333;">Partial Payment Option</h2>
      <p style="color:#666;font-size:15px;line-height:1.6;margin:0;">
        Are you sure you want to use the <strong>40% now / 60% later</strong> payment option?
      </p>
    </div>

    <div style="background:#f9f9f9;border-radius:8px;padding:20px;margin-bottom:24px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px; padding-bottom:2px; border-bottom:1px dashed #e5e7eb >
        <span style="color:#666; font-weight:600;">First Payment (40%)</span>
        <span style="font-weight:600;color:#ef3a24;">Invoice coming soon</span>
      </div>
      <div style="height:1px;background:#ddd;margin:12px 0;"></div>
      <div style="display:flex;justify-content:space-between;">
        <span style="color:#666; font-weight:600;">Final Payment (60%)</span>
        <span style="font-weight:600;color:#333;">At shipping</span>
      </div>
    </div>

    <div style="display:flex;gap:12px;">
      <button id="cancel-btn" style="flex:1;background:#fff;color:#333;border:1px solid #ddd;padding:12px;border-radius:6px;font-size:15px;font-weight:500;cursor:pointer;transition:all 0.2s;">
        Cancel
      </button>
      
      <button id="confirm-btn" style="flex:1;background-color:#ef3a24;color:{{ block.settings.text_color | default: '#ffffff' }};padding:12px;border:none;border-radius:6px;font-size:15px;font-weight:600;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:8px;">
        <span id="confirm-text">Confirm</span>
        <svg id="confirm-spinner" xmlns="http://www.w3.org/2000/svg" style="display:none;" width="20" height="20" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" stroke="#fff" stroke-width="5" fill="none" stroke-linecap="round" stroke-dasharray="30 150" />
        </svg>
      </button>
    </div>

  </div>
</div>

<!-- SUCCESS MODAL -->
<div id="x-success-modal" style="display:none;position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);justify-content:center;align-items:center;">
  <div style="background:white;width:90%;max-width:430px;padding:32px;border-radius:10px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.18);">
    <div id="x-success-tick" style="width:70px;height:70px;border-radius:50%;background:#39c36e;border:4px solid #39c36e;display:flex;justify-content:center;align-items:center;margin:0 auto 22px;font-size:38px;color:#FFFFFF;opacity:0;transform:scale(0.5);transition:all .35s ease;">✔</div>
    <h2 style="margin-bottom:10px;font-size:22px;font-weight:600;">Your order has been received!</h2>
    <p style="color:#666;margin-bottom:32px;font-size:15px;line-height:1.45;">Thank you for choosing the Partial Payment option (40% now / 60% later). We will send the invoice for the initial 40% payment shortly, and the remaining 60% will be invoiced at the time of shipping. Please check your email for updates.</p>
    <button id="x-success-close" style="background:#1463ff;color:white;padding:12px 24px;border-radius:8px;font-size:16px;border:none;cursor:pointer;width:100%;">Close</button>
  </div>
</div>

<!-- ERROR MODAL -->
<div id="x-error-modal" style="display:none;position:fixed;inset:0;z-index:999999;background:rgba(0,0,0,0.45);backdrop-filter:blur(4px);justify-content:center;align-items:center;">
  <div style="background:white;width:90%;max-width:430px;padding:32px;border-radius:10px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.18);">
    <div id="x-error-cross" style="width:70px;height:70px;border-radius:50%;background:#d32f2f;border:4px solid #d32f2f;display:flex;justify-content:center;align-items:center;margin:0 auto 22px;font-size:38px;color:#FFFFFF;font-weight:700;opacity:0;transform:scale(0.5);transition:all .35s ease;">✖</div>
    <h2 style="margin-bottom:10px;font-size:22px;font-weight:600;color:#666">We couldn't complete your order</h2>
    <p style="color:#666;margin-bottom:32px;font-size:15px;line-height:1.45;">Please refresh the page and try again. If the issue continues, please contact support with your email and order details.</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button onclick="window.location.reload()" style="background:#1463ff;color:white;padding:12px 18px;border:none;border-radius:8px;font-size:16px;cursor:pointer;flex:1;">Refresh Page</button>
      <a href="mailto:hr@zioncases.com" style="flex:1;text-decoration:none;">
        <button style="background:white;color:#444;border:1px solid #ccc;padding:12px 18px;border-radius:8px;font-size:16px;cursor:pointer;width:100%;">Contact Support</button>
      </a>
    </div>
  </div>
</div>

<style>
  #create-draft-order-notification {
    background-color: {{ block.settings.background_color | default: '#070707ff' }};
    color: {{ block.settings.text_color | default: '#ffffff' }};
    padding: 12px; border: none; font-size: 16px; cursor: pointer; width: 100%; margin-top: 15px;
  }
  .create-draft-order-btn {
    display: block; width: 100%; text-align: center; padding: 14px;
    font-size: 14px; font-weight: 200; border: none; cursor: pointer; transition: all 0.2s ease;
  }
  .create-draft-order-btn.drawer-style {
    background: #1d1d1dff !important; color: #fff !important; border-radius: 14px !important;
    margin: 10px 0 !important; padding: 15px !important; font-weight: 100 !important;
  }
  .create-draft-order-btn.drawer-style:hover { background: #333 !important; }
  .create-draft-order-btn.notification-style { background: #4f5051; color: #fff; margin-bottom: 15px; }
  .create-draft-order-btn.notification-style:hover { transform: translateY(-3px); background: #6b6b6b; }
  @media (max-width: 750px) { #main { justify-content: center !important; } }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
(function() {
  if (window.draftOrderInitialized) return;
  window.draftOrderInitialized = true;

  const draftorderData = JSON.parse(document.getElementById('draftorder-data').textContent);

  let toastContainer = document.createElement('div');
  toastContainer.id = 'toast-container';
  toastContainer.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000000;display:flex;flex-direction:column;gap:10px;max-width:300px;width:100%;pointer-events:none;align-items:center;';
  document.body.appendChild(toastContainer);

  function showToast(message, duration = 7000) {
    const toast = document.createElement('div');
    toast.style.cssText = 'background:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:6px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease;pointer-events:auto;';
    toast.textContent = message;
    toastContainer.appendChild(toast);
    requestAnimationFrame(() => { toast.style.opacity = '1'; });
    setTimeout(() => { toast.style.opacity = '0'; toast.addEventListener('transitionend', () => toast.remove()); }, duration);
  }

  let cachedCart = null;
  let lastCartFetch = 0;
  const CART_FETCH_COOLDOWN = 3000;
  let cartFetchPromise = null;

  async function fetchCart(forceRefresh = false) {
    const now = Date.now();
    
    if (!forceRefresh && cachedCart && (now - lastCartFetch) < CART_FETCH_COOLDOWN) {
      return cachedCart;
    }
    
    if (cartFetchPromise) return cartFetchPromise;
    
    cartFetchPromise = (async () => {
      try {
        const res = await fetch('/cart.js');
        if (!res.ok) {
          console.warn('Cart fetch failed:', res.status);
          return cachedCart || { items: [] };
        }
        
        const text = await res.text();
        if (text.trim().startsWith('<')) {
          console.warn('Rate limit hit');
          return cachedCart || { items: [] };
        }
        
        const cart = JSON.parse(text);
        cachedCart = cart;
        lastCartFetch = Date.now();
        return cart;
      } catch (err) {
        console.error('Cart fetch error', err);
        return cachedCart || { items: [] };
      } finally {
        cartFetchPromise = null;
      }
    })();
    
    return cartFetchPromise;
  }

  function initializeDraftOrder() {
    const modal = document.getElementById('modal-overlay');
    const closeBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const confirmBtn = document.getElementById('confirm-btn');
    const confirmText = document.getElementById('confirm-text');
    const confirmSpinner = document.getElementById('confirm-spinner');

    async function handleDraftOrderClick(e) {
      e.preventDefault();
      
      if (!draftorderData.customer?.email) {
        showToast("Please log in to use this feature.");
        return;
      }
      
      if (!draftorderData.customer?.default_address) {
        showToast("Please add a default address to your account first.");
        return;
      }
      
      const cart = await fetchCart(true);
      if (!cart.items || cart.items.length === 0) {
        showToast("Your cart is empty. Please add items first.");
        return;
      }
      
      modal.style.display = 'flex';
    }

    const openBtn = document.getElementById('create-draft-order');
    if (openBtn) openBtn.addEventListener('click', handleDraftOrderClick);

    let setupInProgress = false;
    const processedContainers = new WeakSet();

    async function setupCartNotificationButton() {
      if (setupInProgress) return;
      setupInProgress = true;

      try {
        const cart = await fetchCart();
        const containers = document.querySelectorAll('.cart-notification, #cart-notification, .cart-drawer, #CartDrawer');
        
        containers.forEach(container => {
          if (processedContainers.has(container)) return;
          
          const existingBtn = container.querySelector('#create-draft-order-notification');
          
          if (!cart.items || cart.items.length === 0) {
            if (existingBtn) existingBtn.remove();
            return;
          }
          
          if (existingBtn) return;
          
          const button = document.createElement('button');
          button.id = 'create-draft-order-notification';
          button.textContent = '{{ block.settings.text | default: "Partial Payment(40/60)" | escape }}';
          
          if (container.classList.contains('cart-drawer') || container.id === 'CartDrawer') {
            button.className = 'create-draft-order-btn drawer-style';
          } else {
            button.className = 'create-draft-order-btn notification-style';
          }
          
          const checkoutBtn = container.querySelector('[href="/checkout"], button[name="checkout"]');
          const linksSection = container.querySelector('.cart-notification__links, .cart-drawer__footer');
          
          if (checkoutBtn) {
            checkoutBtn.parentNode.insertBefore(button, checkoutBtn);
          } else if (linksSection) {
            linksSection.prepend(button);
          } else {
            container.appendChild(button);
          }
          
          button.addEventListener('click', handleDraftOrderClick);
          processedContainers.add(container);
        });
      } finally {
        setupInProgress = false;
      }
    }

    function init() {
      modal.style.display = 'none';
      document.body.appendChild(modal);
      document.body.appendChild(document.getElementById('x-success-modal'));
      document.body.appendChild(document.getElementById('x-error-modal'));
      setupCartNotificationButton();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    let updateTimeout;
    function debouncedSetup() {
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(setupCartNotificationButton, 500);
    }

    document.addEventListener('cart:updated', debouncedSetup);
    document.addEventListener('cart:drawer:open', setupCartNotificationButton);

    let mutationTimeout;
    const observer = new MutationObserver(() => {
      clearTimeout(mutationTimeout);
      mutationTimeout = setTimeout(setupCartNotificationButton, 2000);
    });
    
    const observeTargets = ['.cart-notification', '#cart-notification', '.cart-drawer', '#CartDrawer'];
    observeTargets.forEach(selector => {
      const target = document.querySelector(selector);
      if (target) {
        observer.observe(target, { childList: true, subtree: true });
      }
    });

    if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
    if (cancelBtn) cancelBtn.addEventListener('click', () => { modal.style.display = 'none'; });

    if (confirmBtn) {
      confirmBtn.addEventListener('click', async () => {
        confirmBtn.disabled = true;
        confirmText.style.display = 'none';
        confirmSpinner.style.display = 'inline-block';
        confirmSpinner.style.animation = 'spin 1s linear infinite';

        const defaultAddr = draftorderData.customer.default_address;
        
        const address = {
          address1: defaultAddr.address1 || '',
          apartment: defaultAddr.address2 || '',
          city: defaultAddr.city || '',
          state: defaultAddr.province || '',
          pin: defaultAddr.zip || '',
          company: defaultAddr.company || '',
          country: defaultAddr.country || ''
        };

        const cart = await fetchCart();
        const customer = draftorderData.customer;
        const discount = cart.discount_codes?.[0] || null;

        try {
          const response = await fetch('https://draft-lyart.vercel.app/api/create-draft-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              customer, 
              cart, 
              address, 
              billingAddress: address,
              discount, 
              useShipping: true 
            })
          });

          const result = await response.json();

          modal.style.display = 'none';

          if (result.success) {
            await fetch('/cart/clear.js', { method: 'POST' });

            const successModal = document.getElementById("x-success-modal");
            const tick = document.getElementById("x-success-tick");

            successModal.style.display = "flex";
            setTimeout(() => {
              tick.style.opacity = "1";
              tick.style.transform = "scale(1)";
            }, 80);

            setTimeout(() => {
              successModal.style.display = "none";
              window.location.reload();
            }, 10000);
          } else {
            const errorModal = document.getElementById("x-error-modal");
            const cross = document.getElementById("x-error-cross");

            errorModal.style.display = "flex";
            setTimeout(() => {
              cross.style.opacity = "1";
              cross.style.transform = "scale(1)";
            }, 80);
          }
        } catch (e) {
          modal.style.display = 'none';
          
          const errorModal = document.getElementById("x-error-modal");
          const cross = document.getElementById("x-error-cross");

          errorModal.style.display = "flex";
          setTimeout(() => {
            cross.style.opacity = "1";
            cross.style.transform = "scale(1)";
          }, 100);

          console.error('Draft order error:', e);
        } finally {
          confirmBtn.disabled = false;
          confirmText.style.display = 'inline';
          confirmSpinner.style.display = 'none';
          confirmSpinner.style.animation = '';
        }
      });
    }
  }

  initializeDraftOrder();
  
  const successCloseBtn = document.getElementById("x-success-close");
  if (successCloseBtn) {
    successCloseBtn.onclick = () => {
      document.getElementById("x-success-modal").style.display = "none";
      window.location.reload();
    };
  }
})();
</script>

{% schema %}
{
  "name": "Draft Order Button",
  "target": "body",
  "settings": [
    { "type": "text", "id": "text", "label": "Button Text", "default": "Partial Payment (40/60)" },
    { "type": "color", "id": "background_color", "label": "Button Background Color", "default": "#070707ff" },
    { "type": "color", "id": "text_color", "label": "Button Text Color", "default": "#ffffff" },
    {
      "type": "select", "id": "alignment", "label": "Button Alignment", "default": "flex-end",
      "options": [
        { "value": "flex-start", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "flex-end", "label": "Right" }
      ]
    }
  ],
  "enabled_on": { "templates": ["cart", "product", "collection", "index"] }
}
{% endschema %}